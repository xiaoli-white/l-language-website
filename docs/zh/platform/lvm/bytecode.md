# 字节码

## 概述

## nop

无操作指令

此指令无操作数。

## 栈操作指令

### 压栈指令

将`操作数`的值压入栈顶。

`操作数`: 源寄存器(1 byte)

#### push_1

操作数大小：1 byte

#### push_2

操作数大小：2 byte

#### push_4

操作数大小：4 byte

#### push_8

操作数大小：8 byte

### 弹栈指令

将栈顶的值弹出到`操作数`中。

`操作数`: 源寄存器(1 byte)

#### pop_1

数据大小：1 byte

#### pop_2

数据大小：2 byte

#### pop_4

数据大小：4 byte

#### pop_8

数据大小：8 byte

## 内存操作指令

### 读内存指令

将`操作数1`所指向的`内存地址`的值读入到`操作数2`中。

`操作数1`: 地址寄存器，存储一个内存地址(1 byte)

`操作数2`: 目标寄存器，存储一个值(1 byte)

#### load_1

数据大小：1 byte

#### load_2

数据大小：2 byte

#### load_4

数据大小：4 byte

#### load_8

数据大小：8 byte

### 写内存指令

将`操作数2`的值写入到`操作数1`所指向的`内存地址`中。

`操作数1`: 地址寄存器，存储一个内存地址(1 byte)

`操作数2`: 源寄存器，存储一个值(1 byte)

#### store_1

数据大小：1 byte

#### store_2

数据大小：2 byte

#### store_4

数据大小：4 byte

#### store_8

数据大小：8 byte

## 寄存器操作指令

### mov

移动`操作数1`的值到`操作数2`中。

## 算术指令

### 三操作数指令

`操作数1`: 源寄存器1(1 byte)

`操作数2`: 源寄存器2(1 byte)

`操作数3`: 目标寄存器(1 byte)

#### add

将`操作数1`与`操作数2`相加，结果存储在`操作数3`中。

#### sub

将`操作数1`与`操作数2`相减，结果存储在`操作数3`中。

#### mul

将`操作数1`与`操作数2`相乘，结果存储在`操作数3`中。

#### div

将`操作数1`与`操作数2`相除，结果存储在`操作数3`中。

#### mod

将`操作数1`与`操作数2`取余，结果存储在`操作数3`中。

#### and

将`操作数1`与`操作数2`按位与，结果存储在`操作数3`中。

#### or

将`操作数1`与`操作数2`按位或，结果存储在`操作数3`中。

#### xor

将`操作数1`与`操作数2`按位异或，结果存储在`操作数3`中。

#### shl

将`操作数1`左移`操作数2`位，结果存储在`操作数3`中。

#### shr

将`操作数1`右移`操作数2`位，结果存储在`操作数3`中。

#### ushr

将`操作数1`无符号右移`操作数2`位，结果存储在`操作数3`中。

#### 浮点数运算指令

以`_float`结尾，表示单精度浮点数运算(4 byte)；以`_double`结尾，表示双精度浮点数运算(8 byte)。

> [!NOTE]
> 浮点数运算仅支持`add`,`sub`,`mul`,`div`,`mod`五种指令。

### 双操作数指令

`操作数1`: 源寄存器(1 byte)

`操作数2`: 目标寄存器(1 byte)

#### not

将`操作数1`按位取反，结果存储在`操作数2`中。

#### neg

将`操作数1`取反，结果存储在`操作数2`中。

### 单操作数指令

`操作数`: 寄存器(1 byte)

#### inc

将`操作数`的值加1，结果存储在`操作数`中。

#### dec

将`操作数`的值减1，结果存储在`操作数`中。

## 原子算数指令

以`atomic_`开头，表示原子操作

操作数与普通算术指令一致，其中`第一个操作数`存储一个内存地址

## 比较指令

### cmp

比较两个寄存器中的值，将结果存储在`flags`寄存器的`CMP`位。

`操作数1`: 源寄存器1(1 byte)

`操作数2`: 源寄存器2(1 byte)

`有符号`比较:

|      状态       | `flags`寄存器的`ZERO`位 | `flags`寄存器的`CARRY`位 |
|:-------------:|:------------------:|:-------------------:|
| `操作数1`=`操作数2` |         1          |          0          |
| `操作数1`<`操作数2` |         0          |          1          |
| `操作数1`>`操作数2` |         0          |          0          |

`无符号`比较:

|      状态       | `flags`寄存器的`ZERO`位 | `flags`寄存器的`UNSIGNED`位 |
|:-------------:|:------------------:|:----------------------:|
| `操作数1`=`操作数2` |         1          |           0            |
| `操作数1`<`操作数2` |         0          |           1            |
| `操作数1`>`操作数2` |         0          |           0            |

### atomic_cmp

比较`操作数1`所指向的`内存地址`的值与`操作数2`的值进行比较，将结果存储在`flags`寄存器的`CMP`位。

`操作数1`: 源寄存器1，存储一个内存地址(1 byte)

`操作数2`: 源寄存器2，存储一个值(1 byte)

结果同`cmp`指令。

## 跳转指令

### 无条件跳转指令

#### jump

`操作数`: 寄存器，存储目标地址(1 byte)

#### jump_immediate

`操作数`: 立即数，作为目标地址(8 bytes)

#### invoke

将`下一条指令`的`内存地址`入栈，并跳转到`操作数`所指向的地址。

`操作数`: 寄存器，存储目标地址(1 byte)

#### invoke_immediate

将`下一条指令`的`内存地址`入栈，并跳转到`操作数`所指向的地址。

`操作数`: 立即数，作为目标地址(8 bytes)

#### return

将`栈顶`的`内存地址`出栈，并跳转到该地址。

此指令无操作数。

### 条件跳转指令

`操作数`: 寄存器，存储目标地址(1 byte)

#### je

当`flags`寄存器的`ZERO`位为1时跳转

#### jne

当`flags`寄存器的`ZERO`位为0时跳转

#### jl

当`flags`寄存器的`ZERO`位为0且`CARRY`位为1时跳转

#### jle

当`flags`寄存器的`ZERO`位为1或`CARRY`位为1时跳转

#### jg

当`flags`寄存器的`ZERO`位为0且`CARRY`位为0时跳转

#### jge

当`flags`寄存器的`ZERO`位为1或`CARRY`位为0时跳转

#### jul

当`flags`寄存器的`ZERO`位为0且`UNSIGNED`位为1时跳转

#### jule

当`flags`寄存器的`ZERO`位为1或`UNSIGNED`位为1时跳转

#### jug

当`flags`寄存器的`ZERO`位为0且`UNSIGNED`位为0时跳转

#### juge

当`flags`寄存器的`ZERO`位为1或`UNSIGNED`位为0时跳转

## 其它原子指令

### cas

## 返回值相关指令

### get_result

### set_result

## 内存管理指令

### malloc

### free

### realloc

## 类型转换指令

用于在6种类型间转换(`byte`,`short`,`int`,`long`,`float`,`double`)。

`操作数1`: 源寄存器(1 byte)

`操作数2`: 目标寄存器(1 byte)

| 指令                |        操作         |
|-------------------|:-----------------:|
| `long_to_byte`    |  `long`=>`byte`   |
| `long_to_short`   |  `long`=>`short`  |
| `long_to_int`     |   `long`=>`int`   |
| `byte_to_long`    |  `byte`=>`long`   |
| `short_to_long`   |  `short`=>`long`  |
| `int_to_long`     |   `int`=>`long`   |
| `long_to_double`  | `long`=>`double`  |
| `double_to_long`  | `double`=>`long`  |
| `double_to_float` | `double`=>`float` |
| `float_to_double` | `float`=>`double` |

> [!NOTE]
> 从`大类型`向`小类型`转换时会`截断`，反之会`填充0`。

## 文件操作指令

### open

### close

### read

### write

## 栈帧管理

### create_frame

### destroy_frame

